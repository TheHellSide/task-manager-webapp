<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>To-Do - Profile</title>
    <script>
        (function () {
          const theme = localStorage.getItem("theme") || "light";
          document.documentElement.setAttribute("data-bs-theme", theme);
        })();
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        .top-buttons {
          position: absolute;
          top: 1rem;
          right: 1rem;
          display: flex;
          flex-direction: row;
          align-items: center;
        }
        .top-buttons .btn:not(:first-child) {
          margin-left: 0.5rem;
        }
    </style>
</head>
<body class="bg-body text-body">

<div class="top-buttons">
    <a href="dashboard.html" class="btn btn-outline-primary">‚Üê Dashboard</a>
    <button class="btn btn-outline-secondary theme-toggle" id="themeBtn">üåô</button>
    <button id="logoutBtn" class="btn btn-outline-danger">Logout</button>
</div>

<div class="container py-5">
    <h2 class="mb-4">Profile Settings</h2>

    <div id="message" class="alert" style="display: none;"></div>

    <!-- Update user info -->
    <form id="updateForm" class="mb-5">
        <h5>Update Username & Email</h5>
        <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" id="username" class="form-control" required />
        </div>
        <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" id="email" class="form-control" required />
        </div>
        <button type="submit" class="btn btn-success">Update Info</button>
    </form>

    <!-- Change password -->
    <form id="passwordForm" class="mb-5">
        <h5>Change Password</h5>
        <div class="mb-3">
            <label for="currentPassword" class="form-label">Current Password</label>
            <input type="password" id="currentPassword" class="form-control" required />
        </div>
        <div class="mb-3">
            <label for="newPassword" class="form-label">New Password</label>
            <input type="password" id="newPassword" class="form-control" required />
        </div>
        <div class="mb-3">
            <label for="confirmPassword" class="form-label">Confirm New Password</label>
            <input type="password" id="confirmPassword" class="form-control" required />
        </div>
        <button type="submit" class="btn btn-warning">Change Password</button>
    </form>

    <hr>
    <button id="deleteBtn" class="btn btn-danger">Delete My Account</button>
</div>

<script src="js/theme-toggle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
      const loggedUserStr = localStorage.getItem('loggedUser');
      if (!loggedUserStr) {
      //  window.location.href = 'login.html';
      //  return;
      }

      const loggedUser = JSON.parse(loggedUserStr);
      document.getElementById('username').value = loggedUser.username;
      document.getElementById('email').value = loggedUser.email;

    // Logout button - full logout with API call
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      const userData = JSON.parse(localStorage.getItem('loggedUser'));

      if (!userData || !userData.token || !userData.id) {
        localStorage.removeItem('loggedUser');
        window.location.href = 'login.html';
        return;
      }

      try {
        const response = await fetch(`http://localhost:8080/api/v1/tokens/user/${userData.id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + userData.token
          }
        });

        if (!response.ok) {
          console.warn("Token cleanup failed:", await response.text());
        }
      } catch (err) {
        console.error("Logout failed:", err.message);
      }

      localStorage.removeItem('loggedUser');
      window.location.href = 'login.html';
    });

      // Helper function to get Authorization header
      const getAuthHeaders = () => ({
        'Authorization': 'Bearer ' + loggedUser.token,
        'Content-Type': 'application/json'
      });

      // Update Info
      document.getElementById('updateForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMessages();

        const username = document.getElementById('username').value.trim();
        const email = document.getElementById('email').value.trim();

        try {
          const res = await fetch(`http://localhost:8080/api/v1/user/${loggedUser.id}?username=${encodeURIComponent(username)}&email=${encodeURIComponent(email)}`, {
            method: 'PUT',
            headers: { 'Authorization': 'Bearer ' + loggedUser.token }
          });

          if (res.ok) {
            showSuccess('User information updated successfully.');
            loggedUser.username = username;
            loggedUser.email = email;
            localStorage.setItem('loggedUser', JSON.stringify(loggedUser));
          } else {
            const msg = await res.text();
            showError(msg);
          }
        } catch (err) {
          showError('Network error: ' + err.message);
        }
      });

      // Change Password
      document.getElementById('passwordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMessages();

        const current = document.getElementById('currentPassword').value;
        const newPass = document.getElementById('newPassword').value;
        const confirmPass = document.getElementById('confirmPassword').value;

        if (newPass !== confirmPass) {
          showError('New passwords do not match.');
          return;
        }

        try {
          const verifyRes = await fetch(`http://localhost:8080/api/v1/user/${loggedUser.id}/verify-password`, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify({ password: current })
          });

          if (!verifyRes.ok) {
            showError('Current password is incorrect.');
            return;
          }

          const updateRes = await fetch(`http://localhost:8080/api/v1/user/${loggedUser.id}/password`, {
            method: 'PUT',
            headers: getAuthHeaders(),
            body: JSON.stringify({ password: newPass })
          });

          if (updateRes.ok) {
            showSuccess('Password changed successfully.');
            e.target.reset();
          } else {
            const msg = await updateRes.text();
            showError(msg);
          }
        } catch (err) {
          showError('Network error: ' + err.message);
        }
      });

      // Delete account
      document.getElementById('deleteBtn').addEventListener('click', async () => {
        clearMessages();
        if (!confirm("Are you sure you want to permanently delete your account?")) return;

        try {
          const res = await fetch(`http://localhost:8080/api/v1/user/${loggedUser.id}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + loggedUser.token }
          });

          if (res.ok) {
            localStorage.removeItem('loggedUser');
            window.location.href = 'register.html';
          } else {
            const msg = await res.text();
            showError(msg);
          }
        } catch (err) {
          showError('Network error: ' + err.message);
        }
      });
    });

    function showError(message) {
      const msg = document.getElementById('message');
      msg.className = 'alert alert-danger';
      msg.textContent = message;
      msg.style.display = 'block';
    }

    function showSuccess(message) {
      const msg = document.getElementById('message');
      msg.className = 'alert alert-success';
      msg.textContent = message;
      msg.style.display = 'block';
    }

    function clearMessages() {
      const msg = document.getElementById('message');
      msg.style.display = 'none';
      msg.textContent = '';
    }
</script>
</body>
</html>